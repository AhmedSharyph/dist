// sharyphselect.bundle.min.js

// --- Inject CSS dynamically ---
(function(){
  var css = `
.sharyph-dropdown-wrapper {
  position: relative;
  width: 100%;
}
.sharyph-dropdown-list {
  position: absolute;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background-color: white;
  border: 1px solid #d1d5db; /* Tailwind gray-300 */
  border-radius: 0.25rem; /* Tailwind rounded */
  z-index: 50;
  display: none;
}
.sharyph-dropdown-list div:hover {
  background-color: #e2e8f0; /* Tailwind gray-200 */
}
.sharyph-dropdown-item.active {
  background-color: #3b82f6; /* Tailwind blue-500 */
  color: white;
}`;
  var style = document.createElement("style");
  style.textContent = css;
  document.head.appendChild(style);
})();

// --- Dropdown Library JS ---
class SharyphSelect {
  static instances = [];

  static init({ selector = '.sharyph-select', optionsMap = {}, modeMap = {} } = {}) {
    const elements = document.querySelectorAll(selector);
    elements.forEach(input => {
      if (input.dataset.sharyphInit) return;
      input.dataset.sharyphInit = "true";

      // Options
      let options = input.dataset.options ? JSON.parse(input.dataset.options) : [];
      if (optionsMap[input.name]) options = optionsMap[input.name];

      // Wrapper and dropdown list
      const wrapper = input.parentElement;
      const list = document.createElement('div');
      list.className = 'sharyph-dropdown-list shadow-md rounded';
      wrapper.appendChild(list);

      const populateList = () => {
        list.innerHTML = '';
        options.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'px-2 py-1 cursor-pointer sharyph-dropdown-item';
          div.textContent = opt;
          if (input.value === opt) div.classList.add('active');
          div.addEventListener('click', () => {
            input.value = opt;
            SharyphSelect.highlightItem(list, opt);
            list.style.display = 'none';
          });
          list.appendChild(div);
        });
      };
      populateList();

      // Show/hide dropdown with dynamic positioning
      const showList = () => {
        const rect = input.getBoundingClientRect();
        list.style.display = 'block';
        list.scrollTop = 0;
        const dropdownHeight = list.offsetHeight || 150;
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;
        if (spaceBelow < dropdownHeight && spaceAbove > dropdownHeight) {
          list.style.top = `-${dropdownHeight}px`;
        } else {
          list.style.top = `${input.offsetHeight}px`;
        }
      };
      input.addEventListener('focus', showList);
      input.addEventListener('blur', () => setTimeout(() => list.style.display = 'none', 150));

      // Filter on input
      input.addEventListener('input', () => {
        const val = input.value.toLowerCase();
        list.querySelectorAll('div').forEach(div => {
          div.style.display = div.textContent.toLowerCase().includes(val) ? 'block' : 'none';
        });
        SharyphSelect.highlightItem(list, input.value);
      });

      // Mode handling
      const mode = modeMap[input.name] || input.dataset.mode || 'editable';
      if (mode === 'readonly') input.readOnly = true;

      // Prefill
      if (input.dataset.prefill) {
        input.value = input.dataset.prefill;
        SharyphSelect.highlightItem(list, input.value);
      }

      SharyphSelect.instances.push({ input, list, options });
    });
  }

  static highlightItem(list, value) {
    list.querySelectorAll('.sharyph-dropdown-item').forEach(div => {
      div.classList.toggle('active', div.textContent === value);
    });
  }

  static setOptions(fieldName, optionsArray) {
    SharyphSelect.instances.forEach(inst => {
      if (inst.input.name === fieldName) {
        inst.options = optionsArray;
        inst.input.dataset.options = JSON.stringify(optionsArray);
        inst.list.innerHTML = '';
        optionsArray.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'px-2 py-1 cursor-pointer sharyph-dropdown-item';
          div.textContent = opt;
          div.addEventListener('click', () => {
            inst.input.value = opt;
            inst.list.style.display = 'none';
            SharyphSelect.highlightItem(inst.list, opt);
          });
          inst.list.appendChild(div);
        });
      }
    });
  }

  static prefill(fieldName, value) {
    SharyphSelect.instances.forEach(inst => {
      if (inst.input.name === fieldName) {
        inst.input.value = value;
        SharyphSelect.highlightItem(inst.list, value);
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  SharyphSelect.init();
});
